[Previous](/docs/page00010.md) | [Next](/docs/page00012.md)

# Setting Up the Database & Migrations

This guide walks through the process of connecting the FastAPI application to a PostgreSQL database and setting up a migration system using Alembic. This is a crucial step to move from using dummy data to a persistent, production-ready data store.

We will use two key libraries:
*   **SQLAlchemy**: An Object-Relational Mapper (ORM) that lets us interact with our database using Python classes.
*   **Alembic**: A database migration tool that works with SQLAlchemy to manage changes to the database schema.

### Step 1: Add Dependencies

Add the following libraries to your `requirements.txt` file and install them:

```text
SQLAlchemy
alembic
psycopg2-binary
python-dotenv
```

### Step 2: Configure Database Connection

We use environment variables to handle the database URL securely.

1.  **Create a `.env` file** in the project root to store your local database URL:
    ```
    DATABASE_URL="postgresql://fil:@localhost/leafcloud"
    ```

2.  **Update `.gitignore`** to ensure this file is not committed to version control:
    ```gitignore
    # Environment variables
    .env
    ```

3.  **Update `database.py`** to read this variable. This file is responsible for creating a database session for our endpoints.

### Step 3: Initialize and Configure Alembic

1.  **Initialize Alembic** by running this command in your project root. This creates the `alembic` directory and `alembic.ini` file.
    ```bash
    alembic init alembic
    ```

2.  **Configure `alembic.ini`**: Open `alembic.ini` and set the `sqlalchemy.url` to your database connection string so Alembic can find your database.
    ```ini
    sqlalchemy.url = postgresql://fil:@localhost/leafcloud
    ```

3.  **Configure `alembic/env.py`**: Open `alembic/env.py` and tell it where to find your SQLAlchemy models. Find the line `target_metadata = None` and replace it with:
    ```python
    # Add this to the top of the file to help with imports
    import sys, os
    sys.path.insert(0, os.path.realpath(os.path.join(os.path.dirname(__file__), '..')))

    # Import your Base from your models file
    from models import Base
    target_metadata = Base.metadata
    ```

### Step 4: Generate and Apply Your First Migration

1.  **Generate the migration script**: Alembic will compare your `models.py` file to the database and generate a script to create the `readings` table.
    ```bash
    alembic revision --autogenerate -m "Create readings table"
    ```

2.  **Apply the migration**: This command runs the script and applies the changes to your database.
    ```bash
    alembic upgrade head
    ```

Your database is now set up with a `readings` table, and you have a repeatable process for managing future schema changes.

[Previous](/docs/page00010.md) | [Next](/docs/page00012.md)